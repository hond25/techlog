<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>振り返り ({{ progress }}) - Tech Log</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Jost:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://indestructibletype-fonthosting.github.io/renner.css" type="text/css" charset="utf-8" />

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <style>
        body {
            font-family: 'Jost', 'Noto Sans JP', -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            background-color: #FBFBFD;
            color: #1D1D1F;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            line-height: 1.6;
        }

        #header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 70px;
            padding: 0 40px;
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .site_title {
            color: #1D1D1F;
            font-family: 'Renner*', sans-serif;
            font-weight: bold;
            font-size: 1.5rem;
            margin: 0;
            letter-spacing: -0.02em;
        }

        .user-info {
            font-size: 0.9em;
            color: #86868B;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
        }

        .container {
            max-width: 800px;
            width: 90%;
            margin: 40px auto 60px auto;
            padding: 60px;
            background-color: #FFFFFF;
            border-radius: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            box-sizing: border-box;
            position: relative;
        }

        .progress-badge {
            position: absolute;
            top: -15px;
            right: 40px;
            background-color: #000000;
            color: white;
            padding: 8px 20px;
            border-radius: 100px;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 0.9em;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .article-title {
            margin-top: 10px;
            margin-bottom: 10px;
            font-size: 2em;
            font-weight: 700;
            line-height: 1.3;
            letter-spacing: -0.02em;
            color: #1D1D1F;
        }

        .source {
            color: #86868B;
            font-size: 0.95em;
            margin-bottom: 30px;
            font-family: 'Inter', sans-serif;
        }
        .source a {
            color: #0066CC;
            text-decoration: none;
            font-weight: 600;
        }
        .source a:hover {
            text-decoration: underline;
        }

        .summary {
            color: #1D1D1F;
            line-height: 1.8;
            font-size: 1.05em;
            padding: 24px;
            background-color: #F5F5F7;
            border-radius: 16px;
            margin-bottom: 40px;
        }

        .form-group {
            margin-bottom: 2em;
        }
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 12px;
            font-size: 0.95em;
            color: #1D1D1F;
        }

        .form-group textarea {
            width: 100%;
            padding: 16px;
            font-size: 1em;
            border: 1px solid #E5E5EA;
            border-radius: 12px;
            box-sizing: border-box;
            min-height: 120px;
            resize: vertical;
            background-color: #FBFBFD;
            color: #1D1D1F;
            font-family: 'Jost', 'Noto Sans JP', sans-serif;
            transition: all 0.2s;
        }
        .form-group textarea:focus {
            outline: none;
            background-color: white;
            border-color: #0066CC;
            box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
        }

        .tag-select-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .tag-select-group input[type="radio"] {
            display: none;
        }
        .tag-select-group label {
            display: inline-block;
            background-color: white;
            color: #86868B;
            padding: 10px 20px;
            border-radius: 100px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #E5E5EA;
            font-weight: 500;
        }
        
        .tag-select-group label:hover {
            background-color: #F5F5F7;
            border-color: #D1D1D6;
            color: #1D1D1F;
        }

        .tag-select-group input[type="radio"]:checked + label {
            background-color: #000000;
            color: white;
            border-color: #000000;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }

        .workflow-nav {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-top: 50px;
            gap: 15px;
            padding-top: 30px;
            border-top: 1px dashed #E5E5EA;
        }

        .workflow-nav button, .workflow-nav .skip-btn {
            padding: 14px 32px;
            border-radius: 100px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            font-family: 'Inter', sans-serif;
            border: none;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .workflow-nav button[type="submit"] {
            background-color: #000000;
            color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .workflow-nav button[type="submit"]:hover {
            background-color: #1D1D1F;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .workflow-nav .skip-btn {
            background-color: white;
            color: #86868B;
            border: 1px solid #E5E5EA;
        }
        .workflow-nav .skip-btn:hover {
            background-color: #F5F5F7;
            color: #1D1D1F;
        }

        @media (max-width: 768px) {
            #header { padding: 0 20px; height: 60px; }
            .site_title { font-size: 1.3rem; }
            
            .container {
                padding: 30px 20px;
                width: 95%;
                margin-top: 30px;
            }
            .article-title { font-size: 1.5em; }
            
            .workflow-nav {
                flex-direction: column-reverse;
                gap: 15px;
            }
            .workflow-nav button, .workflow-nav .skip-btn {
                width: 100%;
            }
            
            .progress-badge {
                position: static;
                display: inline-block;
                margin-bottom: 20px;
                font-size: 0.8em;
            }
        }
    </style>
</head>
<body>
    <header id="header">
        <h1 class="site_title">Tech Log</h1>
        <div class="user-info">
            <span>{{ user_email }}</span>
        </div>
    </header>

    <div class="container">
        <div class="progress-badge">ページ: {{ progress }}</div>
        
        <h2 class="article-title">{{ article.generatedTitle }}</h2>
        <p class="source">情報元: {{ article.source }} | <a href="{{ article.originalUrl }}" target="_blank" rel="noopener noreferrer">元の記事を読む</a></p>
        
        <div class="summary">
            {{ article.summary }}
        </div>
        
        <form id="reflection-form">
            <div class="form-group">
                <label>役に立ったか（ティア）</label>
                <div class="tag-select-group">
                    <input type="radio" id="u-s" name="usefulness" value="tier-s"><label for="u-s">S (殿堂入り)</label>
                    <input type="radio" id="u-a" name="usefulness" value="tier-a"><label for="u-a">A (非常に役立った)</label>
                    <input type="radio" id="u-b" name="usefulness" value="tier-b"><label for="u-b">B (役立った)</label>
                    <input type="radio" id="u-c" name="usefulness" value="tier-c"><label for="u-c">C (普通)</label>
                    <input type="radio" id="u-d" name="usefulness" value="tier-d"><label for="u-d">D (あまり役立たなかった)</label>
                </div>
            </div>
            
            <div class="form-group">
                <label>サイトを見た印象</label>
                <div class="tag-select-group">
                    <input type="radio" id="i-interesting" name="impression" value="impression-interesting"><label for="i-interesting">興味深い</label>
                    <input type="radio" id="i-useful" name="impression" value="impression-useful"><label for="i-useful">使えそう</label>
                    <input type="radio" id="i-old" name="impression" value="impression-old"><label for="i-old">情報が古い</label>
                    <input type="radio" id="i-boring" name="impression" value="impression-boring"><label for="i-boring">つまらない</label>
                </div>
            </div>
            
            <div class="form-group">
                <label>サイトのコンテンツ</label>
                <div class="tag-select-group">
                    <input type="radio" id="c-tutorial" name="content_type" value="content-tutorial"><label for="c-tutorial">チュートリアル</label>
                    <input type="radio" id="c-reference" name="content_type" value="content-reference"><label for="c-reference">リファレンス</label>
                    <input type="radio" id="c-techblog" name="content_type" value="content-techblog"><label for="c-techblog">技術ブログ</label>
                    <input type="radio" id="c-news" name="content_type" value="content-news"><label for="c-news">ニュース記事</label>
                    <input type="radio" id="c-personal" name="content_type" value="content-personal"><label for="c-personal">個人ブログ</label>
                    <input type="radio" id="c-other" name="content_type" value="content-other"><label for="c-other">その他</label>
                </div>
            </div>
            
            <div class="form-group">
                <label for="specific_impression">具体的な印象</label>
                <textarea id="specific_impression" name="specific_impression" placeholder="例：〇〇の解説がわかりやすかった"></textarea>
            </div>
            
            <div class="form-group">
                <label for="why_important">なぜこの情報が重要だと感じたのか</label>
                <textarea id="why_important" name="why_important" placeholder="例：現在開発中の機能に直接応用できるため"></textarea>
            </div>
            
            <div class="form-group">
                <label for="what_i_got">何を得ることができたか</label>
                <textarea id="what_i_got" name="what_i_got" placeholder="例：FirebaseのAuthentication周りの実装パターン"></textarea>
            </div>
            
            <div class="form-group">
                <label for="memo">メモ</label>
                <textarea id="memo" name="memo" placeholder="その他、自由なメモ"></textarea>
            </div>

            <div class="workflow-nav">
                <a href="#" id="skip-btn" class="skip-btn">スキップ</a>
                <button type="submit">保存して次へ</button>
            </div>
        </form>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBjHl2FjglHIU-YNqAu07nsR6Yghk_nyEA", 
            authDomain: "tech-log-1cbba.firebaseapp.com", 
            projectId: "tech-log-1cbba", 
            storageBucket: "tech-log-1cbba.firebasestorage.app", 
            messagingSenderId: "24893956064", 
            appId: "1:24893956064:web:71b8170b7335bee6685585" 
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        
        const all_ids = '{{ all_ids }}'.split(',');
        const current_index = parseInt('{{ current_index }}');
        const next_index = current_index + 1;
        const article_id = '{{ article_id }}';

        function goToNext() {
             if (next_index >= all_ids.length) {
                window.location.href = '/'; 
            } else {
                window.location.href = `/reflect?ids=${all_ids.join(',')}&index=${next_index}`; 
            } 
        }

        document.getElementById('skip-btn').addEventListener('click', (e) => {
             e.preventDefault(); 
             goToNext(); 
        });

        document.getElementById('reflection-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const getRadioValue = (name) => { 
                const selectedRadio = document.querySelector(`input[name="${name}"]:checked`); 
                return selectedRadio ? selectedRadio.value : ""; 
            };
            
            const reflectionData = { 
                usefulness: getRadioValue('usefulness'), 
                impression: getRadioValue('impression'), 
                content_type: getRadioValue('content_type'), 
                specific_impression: document.getElementById('specific_impression').value, 
                why_important: document.getElementById('why_important').value, 
                what_i_got: document.getElementById('what_i_got').value, 
                memo: document.getElementById('memo').value 
            };
            
            const submitBtn = document.querySelector('#reflection-form button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = '保存中...';
            
            auth.currentUser.getIdToken().then((token) => {
                fetch(`/article/${article_id}/reflection`, { 
                    method: 'POST', 
                    headers: { 
                        'Content-Type': 'application/json', 
                        'Authorization': 'Bearer ' + token 
                    }, 
                    body: JSON.stringify(reflectionData) 
                })
                .then(response => { 
                    if (!response.ok) throw new Error('Save failed'); 
                    goToNext(); 
                })
                .catch(error => { 
                    console.error('Error:', error); 
                    alert('保存に失敗しました。'); 
                    submitBtn.disabled = false; 
                    submitBtn.textContent = '保存して次へ';
                });
            });
        });
    </script>
</body>
</html>