<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>振り返り ({{ progress }}) - Tech Log</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            margin: 0; 
            background-color: #f8f9fa; 
        }
        header {
            background-color: #5D6D7E; 
            padding: 1em 2em; 
            border-bottom: 1px solid #dee2e6; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        header h1 {
            margin: 0; 
            font-size: 1.5em; 
            color: #ffffff; 
        }
        .user-info {
            font-size: 0.9em; 
            color: #ffffff; 
        }
        .container {
            max-width: 800px; 
            margin: 2em auto; 
            padding: 2em; 
            background-color: #fff; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
        }
        .article-title {
            margin-top: 0; 
            font-size: 2em; 
        }
        .source {
            color: #6c757d; 
            font-style: italic; 
            margin-bottom: 2em; 
            border-bottom: 1px solid #eee; 
            padding-bottom: 1em; 
        }
        .source a {
            color: #007bff; 
        }
        .summary {
            color: #212529; 
            line-height: 1.7; 
        }
        .form-group {
            margin-bottom: 1.5em; 
        }
        .form-group label {
            display: block; 
            font-weight: bold; 
            margin-bottom: 0.5em; 
        }
        .form-group textarea {
            width: 100%; 
            padding: 0.5em; 
            font-size: 1em; 
            border: 1px solid #ccc; 
            border-radius: 5px; 
            box-sizing: 
            border-box; 
            min-height: 100px; 
            resize: vertical; 
        }
        .tag-select-group {
            display: flex; 
            flex-wrap: wrap; 
            gap: 10px; 
        }
        .tag-select-group input[type="radio"] {
            display: none; 
        }
        .tag-select-group label {
            display: inline-block; 
            background-color: #e9ecef; 
            color: #495057; 
            padding: 0.6em 1em; 
            border-radius: 15px; 
            font-size: 0.9em; 
            cursor: pointer; 
            transition: all 0.2s ease-in-out; 
            border: 1px solid #e9ecef; 
        }
        .tag-select-group label:hover {
            background-color: #d3dce3; 
            border-color: #b6c3d0; 
        }
        .tag-select-group input[type="radio"]:checked + label {
            background-color: #007bff; 
            color: white; 
            border-color: #0056b3; 
            font-weight: bold; 
        }
        .workflow-nav {
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-top: 1em; 
        }
        .workflow-nav .skip-btn {
            background-color: #6c757d; 
            color: white; 
            padding: 10px 20px; 
            border-radius: 5px; 
            text-decoration: none; 
            font-size: 1em; 
        }
        .workflow-nav button {
            background-color: #007bff; 
            color: white; 
            padding: 10px 20px; 
            border-radius: 5px; 
            text-decoration: none; 
            font-size: 1em; 
            border: none; 
            cursor: pointer; 
        }
        .progress {
            font-size: 1.2em; 
            font-weight: bold; 
        }
    </style>
</head>
<body>
    <header><h1>Tech Log</h1><div class="user-info"><span>{{ user_email }}</span></div></header>
    <div class="container">
        <h2 class="article-title">{{ article.generatedTitle }}</h2>
        <p class="source">情報元: {{ article.source }} | <a href="{{ article.originalUrl }}" target="_blank">元の記事を読む</a></p>
        <p class="summary">{{ article.summary }}</p>
        <hr style="margin: 2em 0;">
        <form id="reflection-form">
            <div class="form-group">
                <label>役に立ったか（ティア）</label>
                <div class="tag-select-group">
                    <input type="radio" id="u-s" name="usefulness" value="tier-s"><label for="u-s">S (殿堂入り)</label>
                    <input type="radio" id="u-a" name="usefulness" value="tier-a"><label for="u-a">A (非常に役立った)</label>
                    <input type="radio" id="u-b" name="usefulness" value="tier-b"><label for="u-b">B (役立った)</label>
                    <input type="radio" id="u-c" name="usefulness" value="tier-c"><label for="u-c">C (普通)</label>
                    <input type="radio" id="u-d" name="usefulness" value="tier-d"><label for="u-d">D (あまり役立たなかった)</label>
                </div>
            </div>
            <div class="form-group">
                <label>サイトを見た印象</label>
                <div class="tag-select-group">
                    <input type="radio" id="i-interesting" name="impression" value="impression-interesting"><label for="i-interesting">興味深い</label>
                    <input type="radio" id="i-useful" name="impression" value="impression-useful"><label for="i-useful">使えそう</label>
                    <input type="radio" id="i-old" name="impression" value="impression-old"><label for="i-old">情報が古い</label>
                    <input type="radio" id="i-boring" name="impression" value="impression-boring"><label for="i-boring">つまらない</label>
                </div>
            </div>
            <div class="form-group">
                <label>サイトのコンテンツ</label>
                <div class="tag-select-group">
                    <input type="radio" id="c-tutorial" name="content_type" value="content-tutorial"><label for="c-tutorial">チュートリアル</label>
                    <input type="radio" id="c-reference" name="content_type" value="content-reference"><label for="c-reference">リファレンス</label>
                    <input type="radio" id="c-techblog" name="content_type" value="content-techblog"><label for="c-techblog">技術ブログ</label>
                    <input type="radio" id="c-news" name="content_type" value="content-news"><label for="c-news">ニュース記事</label>
                    <input type="radio" id="c-personal" name="content_type" value="content-personal"><label for="c-personal">個人ブログ</label>
                    <input type="radio" id="c-other" name="content_type" value="content-other"><label for="c-other">その他</label>
                </div>
            </div>
            <div class="form-group"><label for="specific_impression">具体的な印象</label><textarea id="specific_impression" name="specific_impression"></textarea></div>
            <div class="form-group"><label for="why_important">なぜこの情報が重要だと感じたのか</label><textarea id="why_important" name="why_important"></textarea></div>
            <div class="form-group"><label for="what_i_got">何を得ることができたか</label><textarea id="what_i_got" name="what_i_got"></textarea></div>
            <div class="form-group"><label for="memo">メモ</label><textarea id="memo" name="memo"></textarea></div>
            <div class="workflow-nav"><a href="#" id="skip-btn" class="skip-btn">スキップ</a><span class="progress">{{ progress }}</span><button type="submit">保存して次へ</button></div>
        </form>
    </div>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBjHl2FjglHIU-YNqAu07nsR6Yghk_nyEA", 
            authDomain: "tech-log-1cbba.firebaseapp.com", 
            projectId: "tech-log-1cbba", 
            storageBucket: "tech-log-1cbba.firebasestorage.app", 
            messagingSenderId: "24893956064", 
            appId: "1:24893956064:web:71b8170b7335bee6685585" 
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const all_ids = '{{ all_ids }}'.split(',');
        const current_index = parseInt('{{ current_index }}');
        const next_index = current_index + 1;
        const article_id = '{{ article_id }}';
        function goToNext() {
             if (next_index >= all_ids.length) {
                window.location.href = '/'; 
            } else {
                window.location.href = `/reflect?ids=${all_ids.join(',')}&index=${next_index}`; 
            } 
        }
        document.getElementById('skip-btn').addEventListener('click', (e) => {
             e.preventDefault(); goToNext(); 
        });
        document.getElementById('reflection-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const getRadioValue = (name) => { const selectedRadio = document.querySelector(`input[name="${name}"]:checked`); return selectedRadio ? selectedRadio.value : ""; };
            const reflectionData = { usefulness: getRadioValue('usefulness'), impression: getRadioValue('impression'), content_type: getRadioValue('content_type'), specific_impression: document.getElementById('specific_impression').value, why_important: document.getElementById('why_important').value, what_i_got: document.getElementById('what_i_got').value, memo: document.getElementById('memo').value };
            document.querySelector('#reflection-form button').disabled = true;
            auth.currentUser.getIdToken().then((token) => {
                fetch(`/article/${article_id}/reflection`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token }, body: JSON.stringify(reflectionData) })
                .then(response => { if (!response.ok) throw new Error('Save failed'); goToNext(); })
                .catch(error => { console.error('Error:', error); alert('保存に失敗しました。'); document.querySelector('#reflection-form button').disabled = false; });
            });
        });
    </script>
</body>
</html>